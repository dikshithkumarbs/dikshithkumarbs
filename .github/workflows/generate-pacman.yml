name: Generate Pacman Contribution Graph

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # daily at 02:00 UTC (optional)

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (with token)
        uses: actions/checkout@v4
        with:
          persist-credentials: true  # allow pushes using GITHUB_TOKEN

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Download pacman generator (no git clone)
        run: |
          rm -rf pacman_tmp || true
          mkdir -p pacman_tmp
          echo "Downloading maurodesouz/maurodesouz main branch as zip..."
          curl -L -o pacman_tmp/pacman.zip https://github.com/maurodesouz/maurodesouz/archive/refs/heads/main.zip
          unzip -q pacman_tmp/pacman.zip -d pacman_tmp
          # move extracted folder contents up one level (the zip contains a folder named maurodesouz-main)
          mv pacman_tmp/maurodesouz-main/* pacman_tmp/ || true
          rm -f pacman_tmp/pacman.zip
          echo "List pacman_tmp/ after download:"
          ls -la pacman_tmp

      - name: Install pacman generator deps (if any)
        working-directory: pacman_tmp
        run: |
          if [ -f package.json ]; then
            npm ci --silent
          else
            echo "No package.json found; skipping npm install."
          fi
          echo "Working dir files:"
          ls -la

      - name: Run generator for this username
        env:
          TARGET_USERNAME: ${{ github.repository_owner }}
        working-directory: pacman_tmp
        run: |
          echo "Attempting known generator entrypoints..."
          set -e || true
          # try npm script named generate
          if npm run | grep -q "generate"; then
            echo "Running: npm run generate -- --username $TARGET_USERNAME"
            npm run generate --silent -- --username "$TARGET_USERNAME" || true
          fi
          # fallback to common node scripts
          if [ -f index.js ]; then
            echo "Running: node index.js --username $TARGET_USERNAME"
            node index.js --username "$TARGET_USERNAME" || true
          fi
          if [ -f generate.js ]; then
            echo "Running: node generate.js --username $TARGET_USERNAME"
            node generate.js --username "$TARGET_USERNAME" || true
          fi
          # If there is a specific script file honored by that repo, it's now run.
          echo "Done attempting to run generator. Listing files:"
          ls -la
          if [ -d output ]; then
            echo "Generator placed output/ in pacman_tmp:"
            ls -la output || true
          fi

      - name: Copy generated output into this repo
        run: |
          mkdir -p output
          # try common output locations
          if [ -d pacman_tmp/output ]; then
            cp -r pacman_tmp/output/* output/ || true
          fi
          if [ -d pacman_tmp/dist ]; then
            cp -r pacman_tmp/dist/* output/ || true
          fi
          if [ -d pacman_tmp/output_images ]; then
            cp -r pacman_tmp/output_images/* output/ || true
          fi
          echo "Files copied into output/ (if any):"
          ls -la output || true

      - name: Commit and push generated output (if any)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add output || true
          # Always show git status for debugging
          git status --porcelain || true
          if git diff --cached --quiet; then
            echo "No changes in output to commit."
            exit 0
          fi
          git commit -m "chore: update pacman contribution graph for ${{ github.repository_owner }}" || true
          git push origin HEAD:${{ github.ref_name }} || (git push origin HEAD && echo "Pushed fallback")
